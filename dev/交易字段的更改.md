[TOC]



### 概述

交易字段需要进行删改，根据智能合约Maskash.sol，新增交易字段并修改相关功能函数，需要删除的字段暂时保留但不再使用。

同时新增购币字段。

### 在transaction中新增交易字段

```go
位于core/types/transaction.go的type txdata struct {}中
	//新增交易字段
	SnO   uint64 //代币序列号
	rR1   uint64 //随机数，交易时对交易金额v_r进行加密
	CmSpk uint64 //发送方公钥的承诺
	CmRpk uint64 //接收方公钥的承诺
	CmO   uint64 //原始金额承诺
	CmS   uint64 //消费金额承诺
	CmR   uint64 //找零金额承诺
	EvR   uint64 //E(v_r) = (v_r * G1_R + r_r2 * H_R, r_r2 * G2_R)
	EvR0  uint64 //EvR 的后64位
	EvR_  uint64 //E(v_r)’ = (v_r * G1 + r_r3 * H, r_r3 * G2；S_pk * G1 + r_spk * H，r_spk * G2；R_pk * G1 + r_rpk * H，r_rpk * G2)
	EvR_0 uint64 //EvR_ 的后64位
	pi    uint64 //零知识证明Π

	//新增购币字段
	ID uint64 //购币标识
	Sig uint64 //发行者签名
	CmV uint64 //购币承诺
	EpkV uint64 //E(pk,v),监管者公钥对购币用户公钥和购币金额的加密
```

### 下面的新增函数和修改函数都服务于新增的交易字段和购币字段

### 新增函数

#### 函数组

```go
//位于core/types/transaction.go
func (tx *Transaction) SnO() uint64        { return tx.data.SnO }
func (tx *Transaction) CmSpk() uint64      { return tx.data.CmSpk }
func (tx *Transaction) CmRpk() uint64      { return tx.data.CmRpk }
func (tx *Transaction) CmS() uint64        { return tx.data.CmS }
func (tx *Transaction) CmR() uint64        { return tx.data.CmR }
func (tx *Transaction) EvR() uint64        { return tx.data.EvR }
func (tx *Transaction) EvR0() uint64       { return tx.data.EvR0 }
func (tx *Transaction) EvR_() uint64       { return tx.data.EvR_ }
func (tx *Transaction) EvR_0() uint64      { return tx.data.EvR_0 }
func (tx *Transaction) pi() uint64         { return tx.data.pi }
func (tx *Transaction) ID() uint64         { return tx.data.ID }
func (tx *Transaction) Sig() uint64        { return tx.data.Sig }
func (tx *Transaction) CmV() uint64        { return tx.data.CmV }
func (tx *Transaction) EpkV() uint64       { return tx.data.EpkV }
```

返回新增字段的具体值

### 修改函数

#### func NewTransaction(nonce uint64, to common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) 

```go
//位于core/types/transaction.go
func NewTransaction(nonce uint64, to common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) *Transaction {
	return newTransaction(nonce, &to, amount, gasLimit, gasPrice, data)
}
```

修改为

```go
//位于core/types/transaction.go
func NewTransaction(nonce uint64, to common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte, SnO uint64, rR1 uint64, CmSpk uint64, CmRpk uint64, CmO uint64,
	CmS uint64, CmR uint64, EvR uint64, EvR0 uint64, EvR_ uint64, EvR_0 uint64, pi uint64, ID uint64, Sig uint64, CmV uint64, EpkV uint64) *Transaction {
	return newTransaction(nonce, &to, amount, gasLimit, gasPrice, data, SnO, rR1, CmSpk, CmRpk, CmO, CmS, CmR, EvR, EvR0, EvR_, EvR_0, pi, ID, Sig, CmV, EpkV)
}
```

#### func NewContractCreation(nonce uint64, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte)

```go
//位于core/types/transaction.go
func NewContractCreation(nonce uint64, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) *Transaction {
	return newTransaction(nonce, nil, amount, gasLimit, gasPrice, data)
}	
```

修改为

```go
//位于core/types/transaction.go
func NewContractCreation(nonce uint64, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte, SnO uint64, rR1 uint64, CmSpk uint64, CmRpk uint64, CmO uint64,
	CmS uint64, CmR uint64, EvR uint64, EvR0 uint64, EvR_ uint64, EvR_0 uint64, pi uint64, ID uint64, Sig uint64, CmV uint64, EpkV uint64) *Transaction {
	return newTransaction(nonce, nil, amount, gasLimit, gasPrice, data, SnO, rR1, CmSpk, CmRpk, CmO, CmS, CmR, EvR, EvR0, EvR_, EvR_0, pi, ID, Sig, CmV, EpkV)
}
```

#### func newTransaction(nonce uint64, to *common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte)

```go
//位于core/types/transaction.go
func newTransaction(nonce uint64, to *common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) *Transaction {
if len(data) > 0 {
		data = common.CopyBytes(data)
	}
	d := txdata{
		AccountNonce: nonce,
		Recipient:    to,
		Payload:      data,
		Amount:       new(big.Int),
		GasLimit:     gasLimit,
		Price:        new(big.Int),
		V:            new(big.Int),
		R:            new(big.Int),
		S:            new(big.Int),
	}
	if amount != nil {
		d.Amount.Set(amount)
	}
	if gasPrice != nil {
		d.Price.Set(gasPrice)
	}

	return &Transaction{data: d}
}
```

修改为

```go
//位于core/types/transaction.go
func newTransaction(nonce uint64, to *common.Address, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte, SnO uint64, rR1 uint64, CmSpk uint64, CmRpk uint64, CmO uint64,
	CmS uint64, CmR uint64, EvR uint64, EvR0 uint64, EvR_ uint64, EvR_0 uint64, pi uint64, ID uint64, Sig uint64, CmV uint64, EpkV uint64) *Transaction {
	if len(data) > 0 {
		data = common.CopyBytes(data)
	}
	d := txdata{
		AccountNonce: nonce,
		Recipient:    to,
		Payload:      data,
		Amount:       new(big.Int),
		GasLimit:     gasLimit,
		Price:        new(big.Int),
		V:            new(big.Int),
		R:            new(big.Int),
		S:            new(big.Int),
		SnO:          SnO,
		rR1:          rR1,
		CmSpk:        CmSpk,
		CmRpk:        CmRpk,
		CmO:          CmO,
		CmS:          CmS,
		CmR:          CmR,
		EvR:          EvR,
		EvR0:         EvR0,
		EvR_:         EvR_,
		EvR_0:        EvR_0,
		pi:           pi,
		ID:           ID,
		Sig:          Sig,
		CmV:          CmV,
		EpkV:         EpkV,
	}
	if amount != nil {
		d.Amount.Set(amount)
	}
	if gasPrice != nil {
		d.Price.Set(gasPrice)
	}

	return &Transaction{data: d}
}
```

#### 对其他地方的字段和函数的修改都是因为修改了上面三个函数，而那些函数调用了那三个函数中的至少一个。相关diff请查阅GitHub上Fu-XDU在`Sep 16, 2020`的commit（父哈希为63f5545）。